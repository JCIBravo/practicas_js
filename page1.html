<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>My Simple iBus</title>
    <link rel="stylesheet" href="estilo.css">
    <link rel="icon" href="https://upload.wikimedia.org/wikipedia/commons/9/93/Aiga_bus.svg">
    <script type='text/javascript' src='config.js'></script>
    <script>
        var apiTMB = config.TMB_API_TOKEN
        var valor = prompt("Introduce tu código de parada")
        if (valor == "" || valor == " " || valor == null){
            valor = 0
        }
        let size = 0

        function addRow(data){
            const table = document.getElementById('iBus'),
                row = table.insertRow(1),
                cell1 = row.insertCell(0),
                cell2 = row.insertCell(1),
                cell3 = row.insertCell(2);

            if (data[size - 1].line.includes("D")){
                cell1.style.backgroundColor = "#894796"
                cell1.style.color = "#FFFFFF"
            }

            else if (data[size - 1].line.includes("H")){
                cell1.style.backgroundColor = "#2D4191"
                cell1.style.color = "#FFFFFF"
            }

            else if (data[size - 1].line.includes("V")){
                cell1.style.backgroundColor = "#547B31"
                cell1.style.color = "#FFFFFF"
            }

            else if (data[size - 1].line.includes("X")) {
                cell1.style.backgroundColor = "#000000"
                cell1.style.color = "#FFFFFF"
            }

            else {
                cell1.style.backgroundColor = "#C62A0F"
                cell1.style.color = "#FFFFFF"
            }

            cell1.innerHTML = data[size - 1].line
            cell2.innerHTML = data[size - 1].destination
            cell3.innerHTML = 'Muy pronto'
            size--
        }

        function addRowErr(data){
            const table = document.getElementById('iBus'),
                row = table.insertRow(1),
                cell1 = row.insertCell(0);
                cell1.colSpan = 3;
            cell1.innerHTML = 'No se pueden obtener datos'
            size = 0
        }

        function check(data, listSize){
            do {
                try {
                    addRow(data)
                } catch (e) {
                    addRowErr(data)
                    break
                }
            } while (size != 0)
        }

        let url_iBus = `https://api.tmb.cat/v1/ibus/stops/${valor}${apiTMB}`
        fetch(url_iBus)
            .then(res => res.json())
            .then(out => {
                    size = out.data.ibus.length
                    check(out.data.ibus, size
                    )
                }
            )

        let url_Parada = `https://api.tmb.cat/v1/transit/parades/${valor}${apiTMB}`
        fetch(url_Parada)
            .then(res => res.json())
            .then(out => {
                try{
                    document.getElementById("nomParada").style.display = "inline"
                    document.getElementById("nomParada").innerText = "[" + out.features[0].properties.CODI_PARADA + "] " + out.features[0].properties.NOM_PARADA
                } catch (e) {
                    document.getElementById("nomParada").style.display = "none"
                    }
                }
            )

    </script>
</head>
<body>
    <div class="lista">
        <select onchange="if (this.value) window.location.href=this.value">
            <option value="">Selecciona página:</option>
            <option value="./page1.html">Página 1</option>
            <option value="./index.html">Carita</option>
        </select>
    </div>
    <br/>
    <h1 id="nomParada">Cargando...</h1>
    <table id="iBus" class="tabla">
        <tbody>
        <tr>
            <td class="tituloTabla">Linea</td>
            <td class="tituloTabla">Proximo bus</td>
            <td class="tituloTabla">Llegada</td>
        </tr>
        </tbody>
    </table>
</body>
</html>