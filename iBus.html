<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>My Simple iBus</title>
    <link rel="stylesheet" href="estilo.css">
    <link rel="icon" href="https://upload.wikimedia.org/wikipedia/commons/9/93/Aiga_bus.svg">
    <script type='text/javascript' src='config.js'></script> <!-- Archivo privado donde lo tengo guarado (est√° en el gitignore) -->
    <script>
        // var TMB_APP_ID = config.TMB_APP_ID
        // var TMB_APP_KEY = config.TMB_APP_KEY
        var TMB_APP_ID = ''
        var TMB_APP_KEY = ''
        var STOPCODE = ''
        let size = 0

        function getStopCode(){
            STOPCODE = document.getElementById("stopCode").value
            if (STOPCODE == "" || STOPCODE == " " || STOPCODE == null){
                STOPCODE = 0
            }
            return STOPCODE
        }

        function addRow(data){
            document.getElementById('iBus').style.display = "table"
            const table = document.getElementById('iBus'),
                row = table.insertRow(1),
                cell1 = row.insertCell(0),
                cell2 = row.insertCell(1),
                cell3 = row.insertCell(2);
                row.id = 'busInfo'

            if (data[size - 1]['line'].includes("D")){
                cell1.style.backgroundColor = "#8E308A"
                cell1.style.color = "#FFFFFF"
            }

            else if (data[size - 1]['line'].includes("H")){
                cell1.style.backgroundColor = "#10069F"
                cell1.style.color = "#FFFFFF"
            }

            else if (data[size - 1]['line'].includes("V")){
                cell1.style.backgroundColor = "#43B02A"
                cell1.style.color = "#FFFFFF"
            }

            else if (data[size - 1]['line'].includes("X")) {
                cell1.style.backgroundColor = "#000000"
                cell1.style.color = "#FFFFFF"
            }

            else {
                cell1.style.backgroundColor = "#DA291C"
                cell1.style.color = "#FFFFFF"
            }

            cell1.style.fontWeight = "bold"
            cell1.innerHTML = data[size - 1]['line']
            cell2.innerHTML = data[size - 1]['destination']
            cell3.innerHTML = data[size - 1]['text-ca']
            size--
        }

        function check(data){
            do {
                try {
                    addRow(data)
                } catch (e) {
                    addRowErr()
                    break
                }
            } while (size != 0)
        }

        function addRowErr(){
            document.getElementById('iBus').style.display = "none"
            cell1.innerHTML = 'No se pueden obtener datos'
        }

        function loadAPI() {
            if (document.getElementById('busInfo') != null){
                do {
                    const row = document.getElementById('busInfo');
                    row.parentElement.removeChild(row);
                } while (document.getElementById('busInfo') != null)
            }

            document.getElementById("nomParada").innerText = "Cargando..."
            TMB_APP_ID = document.getElementById("appID").value;
            TMB_APP_KEY = document.getElementById("appKey").value;
            STOPCODE = getStopCode();
            console.log(TMB_APP_ID, TMB_APP_KEY, STOPCODE);

            let url_iBus = `https://api.tmb.cat/v1/ibus/stops/${STOPCODE}?app_id=${TMB_APP_ID}&app_key=${TMB_APP_KEY}`
            fetch(url_iBus)
                .then(res => res.json())
                .then(out => {
                        size = out.data.ibus.length
                        check(out.data.ibus)
                    }
                )

            let url_Parada = `https://api.tmb.cat/v1/transit/parades/${STOPCODE}?app_id=${TMB_APP_ID}&app_key=${TMB_APP_KEY}`
            fetch(url_Parada)
                .then(res => res.json())
                .then(out => {
                        try{
                            document.getElementById("nomParada").innerText = "[" + out.features[0].properties.CODI_PARADA + "] " + out.features[0].properties.NOM_PARADA
                            document.getElementById("divError").style.display = "none"
                          //document.getElementById("divAviso").style.display = "block"
                        } catch (e) {
                            document.getElementById("nomParada").innerText = "ERROR"
                            document.getElementById("divError").style.display = "block"
                          //document.getElementById("divAviso").style.display = "none"
                    }
                }
            )
        }

    </script>
</head>
<body>
    <div class="lista">
        <select onchange="if (this.value) window.location.href=this.value">
            <option value="#">Selecciona p√°gina:</option>
            <option value="#">iBus (Est√°s aqu√≠)</option>
            <option value="./index.html">Carita</option>
        </select>
    </div>
    <br/>
    <form action="#">
        <label for="appID">APP ID:</label><br>
        <input type="text" id="appID"><br>
        <label for="appKey">APP KEY:</label><br>
        <input type="text" id="appKey"><br><br>
        <label for="appKey">CODIGO DE PARADA:</label><br>
        <input type="number" id="stopCode"><br><br>
        <input type="submit" value="Enviar" onclick="loadAPI()">
    </form>

    <div class="result">
        <h1 id="nomParada">iBus</h1>
        <table id="iBus" class="tabla">
            <tbody>
            <tr class="tituloTabla">
                <td>Linea</td>
                <td class="destinacion">Destinaci√≥n</td>
                <td>Tiempo restante</td>
            </tr>
            </tbody>
        </table>
    </div>

    <div class="error" id="divError">
        <h1>üöç‚ùåÔ∏è ERROR</h1>
        <h2>Comprueba que tengas conexi√≥n a internet, que tus claves de API est√©n bien puestas o, que el c√≥digo de parada haya sido introducido correctamente o que la parada no est√© anulada temporal o permanentemente.</h2>
    </div>

    <div class="aviso" id="divAviso">
        <h2>üöç‚ö†Ô∏è AVISO</h2>
        <h4>Sistema de pr√≥ximo bus actualmente no disponible. (Ya ver√© como lo arreglo 'x] sorry)</h4>
    </div>
</body>
</html>