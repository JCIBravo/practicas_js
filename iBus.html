<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>My Simple iBus</title>
    <link rel="stylesheet" href="estilo.css">
    <link rel="icon" href="https://upload.wikimedia.org/wikipedia/commons/9/93/Aiga_bus.svg">
    <script type='text/javascript' src='config.js'></script>
    <script>
        var apiTMB = config.TMB_API_TOKEN
        var valor = getStopCode()
        let size = 0

        function getStopCode(){
            valor = prompt("🚏 Introduce tu código de parada")
            if (valor == "" || valor == " " || valor == null){
                valor = 0
            }
            return valor
        }

        function addRow(data){
            const table = document.getElementById('iBus'),
                row = table.insertRow(1),
                cell1 = row.insertCell(0),
                cell2 = row.insertCell(1),
                cell3 = row.insertCell(2);

            if (data[size - 1].line.includes("D")){
                cell1.style.backgroundColor = "#8E308A"
                cell1.style.color = "#FFFFFF"
            }

            else if (data[size - 1].line.includes("H")){
                cell1.style.backgroundColor = "#10069F"
                cell1.style.color = "#FFFFFF"
            }

            else if (data[size - 1].line.includes("V")){
                cell1.style.backgroundColor = "#43B02A"
                cell1.style.color = "#FFFFFF"
            }

            else if (data[size - 1].line.includes("X")) {
                cell1.style.backgroundColor = "#000000"
                cell1.style.color = "#FFFFFF"
            }

            else {
                cell1.style.backgroundColor = "#DA291C"
                cell1.style.color = "#FFFFFF"
            }

            cell1.style.fontWeight = "bold"
            cell1.innerHTML = data[size - 1].line
            cell2.innerHTML = data[size - 1].destination
            cell3.style.fontStyle = "italic"
            cell3.innerHTML = 'Muy pronto'
            size--
        }

        function addRowErr(){
            document.getElementById('iBus').style.display = "none"

            cell1.innerHTML = 'No se pueden obtener datos'
        }

        function check(data, listSize){
            do {
                try {
                    addRow(data)
                } catch (e) {
                    addRowErr()
                    break
                }
            } while (size != 0)
        }

        let url_iBus = `https://api.tmb.cat/v1/ibus/stops/${valor}${apiTMB}`
        fetch(url_iBus)
            .then(res => res.json())
            .then(out => {
                    size = out.data.ibus.length
                    check(out.data.ibus, size
                    )
                }
            )

        let url_Parada = `https://api.tmb.cat/v1/transit/parades/${valor}${apiTMB}`
        fetch(url_Parada)
            .then(res => res.json())
            .then(out => {
                try{
                    document.getElementById("nomParada").innerText = "[" + out.features[0].properties.CODI_PARADA + "] " + out.features[0].properties.NOM_PARADA
                    document.getElementById("divAviso").style.display = "block"
                } catch (e) {
                    document.getElementById("nomParada").innerText = "ERROR"
                    document.getElementById("divError").style.display = "block"
                    }
                }
            )

    </script>
</head>
<body>
    <div class="lista">
        <select onchange="if (this.value) window.location.href=this.value">
            <option value="#">Selecciona página:</option>
            <option value="#">iBus (Estás aquí)</option>
            <option value="./index.html">Carita</option>
        </select>
    </div>

    <div class="result">
        <h1 id="nomParada">Cargando...</h1>
        <table id="iBus" class="tabla">
            <tbody>
            <tr class="tituloTabla">
                <td>Linea</td>
                <td class="destinacion">Destinación</td>
                <td>Tiempo restante</td>
            </tr>
            </tbody>
        </table>
    </div>

    <div class="error" id="divError">
        <h1>🚍❌️ ERROR</h1>
        <h2>Comprueba que tengas conexión a internet, que el código de parada haya sido introducido correctamente o que la parada no esté anulada temporal o permanentemente.</h2>
    </div>

    <div class="aviso" id="divAviso">
        <h2>🚍⚠️ AVISO</h2>
        <h4>Sistema de próximo bus actualmente no disponible. (Ya veré como lo arreglo 'x] sorry)</h4>
    </div>

    <button class="iBusPage" onclick="location.reload();">Volver a introducir código de parada</button>
</body>
</html>